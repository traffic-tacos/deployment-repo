apiVersion: batch/v1
kind: Job
metadata:
  name: k6-loadtest-small
  namespace: load-test
  labels:
    app.kubernetes.io/name: load-test-job
    app.kubernetes.io/component: load-test
  spec:
    serviceAccountName: k6-runner
    nodeSelector:
      workload-type: loadtest
    tolerations:
      - effect: NoSchedule
        key: workload
        operator: Equal
        value: loadtest
    volumes:
      - name: aws-iam-token
        projected:
          defaultMode: 420
          sources:
          - serviceAccountToken:
            audience: sts.amazonaws.com
            expirationSeconds: 86400
            path: token
      - name: k6-test-volume
        configMap:
          defaultMode: 420
          name: k6-script-small
    containers:
      - name: k6
        image: grafana/k6:latest
        command: ["k6"]
        args:
          - "run"
          - "/test/script.js"
        ports:
          - containerPort: 6565
        volumeMounts:
          - mountPath: /test
            name: k6-test-volume
            readOnly: true
        env:
          - name: TARGET_BASE_URL
            value: "https://api.traffictacos.store"
          - name: K6_OUT
            value: experimental-prometheus-rw
          - name: K6_PROMETHEUS_RW_SERVER_URL
            value: http://localhost:8005/workspaces/ws-ec1155d6-1ea8-4822-b9e9-fdec9424dcb9/api/v1/remote_write
          - name: K6_PROMETHEUS_RW_TREND_STATS
            value: "p(90),p(95),p(99),max,min,avg,med"
          - name: K6_PROMETHEUS_RW_TAGS
            value: "testid,tags,scenario,url,method,status"
          - name: K6_PROMETHEUS_RW_PUSH_INTERVAL
            value: "15s"
      - name: aws-sigv4-proxy
        image: public.ecr.aws/aws-observability/aws-sigv4-proxy:latest
        args:
          - "--name=aps"
          - "--region=ap-northeast-2"
          - "--host=aps-workspaces.ap-northeast-2.amazonaws.com"
          - "--port=:8005"
        volumeMounts:
        - name: aws-iam-token
          mountPath: /var/run/secrets/eks.amazonaws.com/serviceaccount
          readOnly: true
        ports:
          - containerPort: 8005
    restartPolicy: Never
